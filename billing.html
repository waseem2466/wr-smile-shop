<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WR Smile - Billing with Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f2f4f8; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 960px; margin-top: 40px; }
    .cart-box, .stock-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
    .cart-item input { width: 50px; }
    .cart-item span { flex: 1; }
    .list-group-item { cursor: pointer; }
    .text-success { font-weight: bold; }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">üßæ WR Smile - Billing with Stock</h2>

  <div class="row mb-3">
    <div class="col-md-6">
      <label>Customer Name</label>
      <input type="text" id="customer-name" class="form-control" placeholder="Enter name">
    </div>
    <div class="col-md-6">
      <label>Customer Phone</label>
      <input type="tel" id="customer-phone" class="form-control" placeholder="Ex: 94771234567">
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label>Product</label>
      <input type="text" id="product-search" class="form-control" placeholder="Search product...">
      <div id="search-results" class="list-group mt-1"></div>
    </div>
    <div class="col-md-2">
      <label>Qty</label>
      <input type="number" id="product-qty" class="form-control" value="1">
    </div>
    <div class="col-md-4">
      <label>&nbsp;</label>
      <button class="btn btn-primary w-100" onclick="addSelectedProduct()">Add to Cart</button>
    </div>
  </div>

  <div class="mb-3">
    <label>Discount (Rs.)</label>
    <input type="number" id="discount" class="form-control" value="0">
  </div>

  <div class="mb-3">
    <label>Loan Amount (Rs.)</label>
    <input type="number" id="loan-amount" class="form-control" placeholder="0">
  </div>
  <div class="mb-3">
    <label>Loan Note</label>
    <input type="text" id="loan-note" class="form-control" placeholder="Optional notes">
  </div>

  <div class="cart-box">
    <h5>üõí Cart</h5>
    <div id="cart-items"></div>
    <h5 class="mt-3">Total: Rs. <span id="total-amount">0.00</span></h5>
    <div class="d-grid gap-2 d-md-block mt-3">
      <button class="btn btn-success" onclick="finalizeBill()">üíæ Save Bill</button>
      <button class="btn btn-info" onclick="sendWhatsAppBill()">üì≤ Send WhatsApp</button>
    </div>
  </div>

  <div class="stock-box">
    <h5>üì¶ Product Stock Summary</h5>
    <table class="table table-bordered">
      <thead><tr><th>Name</th><th>Price</th><th>Stock</th></tr></thead>
      <tbody id="stock-summary"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyACehOi7n-dbdN00D4tJr2kD_-AVR6S-Vo",
    authDomain: "wr-smile-shop.firebaseapp.com",
    projectId: "wr-smile-shop",
    storageBucket: "wr-smile-shop.appspot.com",
    messagingSenderId: "299864260187",
    appId: "1:299864260187:web:fa6af65ef95674aff1097e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let cart = [];
  let selectedProduct = null;

  function renderCart() {
    const container = document.getElementById('cart-items');
    container.innerHTML = '';
    let total = 0;
    cart.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <span>${item.name}</span>
        <input type="number" value="${item.qty}" onchange="updateQty(${index}, this.value)">
        <span>Rs. ${(item.qty * item.price).toFixed(2)}</span>
        <button class="btn btn-sm btn-danger" onclick="removeItem(${index})">‚ùå</button>
      `;
      container.appendChild(div);
      total += item.qty * item.price;
    });
    const discount = parseFloat(document.getElementById('discount').value || 0);
    document.getElementById('total-amount').textContent = (total - discount).toFixed(2);
  }

  function updateQty(i, val) {
    cart[i].qty = parseInt(val);
    renderCart();
  }

  function removeItem(i) {
    cart.splice(i, 1);
    renderCart();
  }

  document.getElementById('product-search').addEventListener('input', e => {
    const val = e.target.value.toLowerCase();
    const resultBox = document.getElementById('search-results');
    resultBox.innerHTML = '';
    db.ref('products').once('value', snap => {
      snap.forEach(child => {
        const p = child.val();
        if (p.name.toLowerCase().includes(val)) {
          const el = document.createElement('a');
          el.className = 'list-group-item list-group-item-action';
          el.textContent = `${p.name} - Rs.${p.price}`;
          el.onclick = () => {
            selectedProduct = { ...p, id: child.key };
            document.getElementById('product-search').value = p.name;
            resultBox.innerHTML = '';
          };
          resultBox.appendChild(el);
        }
      });
    });
  });

  function addSelectedProduct() {
    const qty = parseInt(document.getElementById('product-qty').value);
    if (!selectedProduct || qty < 1) return alert("Select product and qty");
    cart.push({ name: selectedProduct.name, price: selectedProduct.price, qty });
    db.ref(`products/${selectedProduct.id}/stock`).transaction(current => (current || 0) - qty);
    renderCart();
    selectedProduct = null;
    document.getElementById('product-search').value = '';
    document.getElementById('product-qty').value = '1';
  }

  async function finalizeBill() {
    const name = document.getElementById('customer-name').value.trim();
    const phone = document.getElementById('customer-phone').value.trim();
    const discount = parseFloat(document.getElementById('discount').value || 0);
    const loanAmount = parseFloat(document.getElementById('loan-amount').value || 0);
    const loanNote = document.getElementById('loan-note').value.trim();
    const total = parseFloat(document.getElementById('total-amount').textContent);

    if (!name || !phone || cart.length === 0) return alert("Fill in all fields");

    const customersRef = db.ref('customers');
    let customerId = null;
    await customersRef.orderByChild('phone').equalTo(phone).once('value', snap => {
      if (snap.exists()) customerId = Object.keys(snap.val())[0];
    });
    if (!customerId) {
      const ref = customersRef.push();
      await ref.set({ name, phone });
      customerId = ref.key;
    }

    const bill = {
      customerId,
      name,
      phone,
      discount,
      total,
      loanAmount,
      loanNote,
      cart,
      date: new Date().toISOString()
    };
    if (loanAmount > 0) {
      await db.ref('loans').push(bill);
      alert("Loan saved!");
    } else {
      await db.ref('sales').push(bill);
      alert("Sale saved!");
    }
    location.reload();
  }

  function sendWhatsAppBill() {
    const name = document.getElementById('customer-name').value;
    const phone = document.getElementById('customer-phone').value;
    const total = document.getElementById('total-amount').textContent;
    let msg = `*WR Smile Bill*\nName: ${name}\n`;
    cart.forEach(p => {
      msg += `- ${p.name} x${p.qty} = Rs.${(p.qty * p.price).toFixed(2)}\n`;
    });
    msg += `Total: Rs.${total}`;
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`);
  }

  function loadStockSummary() {
    db.ref('products').once('value', snap => {
      const body = document.getElementById('stock-summary');
      body.innerHTML = '';
      snap.forEach(child => {
        const p = child.val();
        const row = document.createElement('tr');
        row.innerHTML = `<td>${p.name}</td><td>Rs.${p.price}</td><td>${p.stock}</td>`;
        body.appendChild(row);
      });
    });
  }

  loadStockSummary();
</script>
</body>
</html>
