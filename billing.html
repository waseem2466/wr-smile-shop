<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WR Smile - Billing</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { background: #f2f4f8; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 960px; margin-top: 40px; }
    .cart-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
    .cart-item input { width: 50px; }
    .cart-item span { flex: 1; }
    .list-group-item { cursor: pointer; }
    .print-area { display: none; }
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; top: 0; left: 0; width: 100%; }
    }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">üßæ WR Smile - Billing</h2>

  <div class="mb-3">
    <label>Invoice Number</label>
    <input type="text" id="invoice-number" class="form-control" readonly>
  </div>

  <div class="mb-3">
    <label>Customer Name</label>
    <input type="text" id="customer-name" class="form-control" placeholder="Enter name">
  </div>

  <div class="mb-3">
    <label>Customer WhatsApp Number</label>
    <input type="tel" id="customer-phone" class="form-control" placeholder="Ex: 94771234567">
  </div>

  <div class="mb-3">
    <label>Search Product</label>
    <input type="text" id="product-search" class="form-control" placeholder="Search product...">
    <div id="search-results" class="list-group mt-1"></div>
  </div>

  <div class="mb-3">
    <label>Add Product Manually</label>
    <div class="row g-2">
      <div class="col-md-4"><input type="text" id="manual-name" class="form-control" placeholder="Name"></div>
      <div class="col-md-3"><input type="number" id="manual-price" class="form-control" placeholder="Price"></div>
      <div class="col-md-2"><input type="number" id="manual-qty" class="form-control" placeholder="Qty" value="1"></div>
      <div class="col-md-3"><button class="btn btn-secondary w-100" onclick="addManualProduct()">Add</button></div>
    </div>
  </div>

  <div class="mb-3">
    <label>Discount (Rs.)</label>
    <input type="number" id="discount" class="form-control" value="0">
  </div>

  <div class="mb-3">
    <label>Loan Amount (if not paid now)</label>
    <input type="number" id="loan-amount" class="form-control" placeholder="0">
  </div>

  <div class="mb-3">
    <label>Loan Notes</label>
    <input type="text" id="loan-note" class="form-control" placeholder="Optional details">
  </div>

  <div class="cart-box">
    <h5>üõí Cart Items</h5>
    <div id="cart-items"></div>
    <h5 class="mt-3">Total: Rs. <span id="total-amount">0.00</span></h5>
    <div class="d-grid gap-2 d-md-block mt-3">
      <button class="btn btn-success" onclick="sendWhatsAppBill()">üì≤ Send WhatsApp</button>
      <button class="btn btn-primary ms-2" onclick="printReceipt()">üñ®Ô∏è Print</button>
      <button class="btn btn-danger ms-2" onclick="downloadPDF()">‚¨áÔ∏è Export PDF</button>
    </div>
  </div>

  <!-- Printable -->
  <div class="print-area mt-4">
    <h4 class="text-center">WR Smile & Supplies</h4>
    <p class="text-center">411/7, Kandy Road, Mollipothana | Tel: 076-495-0844</p>
    <p><strong>Invoice:</strong> <span id="print-invoice"></span></p>
    <p><strong>Customer:</strong> <span id="print-customer-name"></span></p>
    <p><strong>Phone:</strong> <span id="print-customer-phone"></span></p>
    <div id="print-items"></div>
    <p><strong>Discount:</strong> Rs. <span id="print-discount"></span></p>
    <p><strong>Total:</strong> Rs. <span id="print-total"></span></p>
    <p><strong>Loan:</strong> Rs. <span id="print-loan"></span> (<span id="print-loan-note"></span>)</p>
    <p class="text-end"><em>Date:</em> <span id="print-date"></span></p>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyACehOi7n-dbdN00D4tJr2kD_-AVR6S-Vo",
    authDomain: "wr-smile-shop.firebaseapp.com",
    projectId: "wr-smile-shop",
    storageBucket: "wr-smile-shop.appspot.com",
    messagingSenderId: "299864260187",
    appId: "1:299864260187:web:fa6af65ef95674aff1097e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let invoiceNumber = "INV-" + Date.now();
  document.getElementById('invoice-number').value = invoiceNumber;

  let cart = [];

  function updateCart() {
    const container = document.getElementById('cart-items');
    container.innerHTML = '';
    let total = 0;

    cart.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <span>${item.name}</span>
        <input type="number" value="${item.qty}" min="1" onchange="updateQty(${i}, this.value)">
        <span>Rs. ${(item.price * item.qty).toFixed(2)}</span>
        <button class="btn btn-sm btn-danger" onclick="removeItem(${i})">‚ùå</button>
      `;
      container.appendChild(div);
      total += item.qty * item.price;
    });

    const discount = parseFloat(document.getElementById('discount').value || 0);
    document.getElementById('total-amount').textContent = (total - discount).toFixed(2);
  }

  function addManualProduct() {
    const name = document.getElementById('manual-name').value;
    const price = parseFloat(document.getElementById('manual-price').value);
    const qty = parseInt(document.getElementById('manual-qty').value || 1);
    if (!name || isNaN(price)) return alert("Please enter product name and price");

    cart.push({ name, price, qty });
    document.getElementById('manual-name').value = '';
    document.getElementById('manual-price').value = '';
    updateCart();
  }

  function updateQty(index, value) {
    cart[index].qty = parseInt(value);
    updateCart();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    updateCart();
  }

  function printReceipt() {
    document.getElementById('print-invoice').textContent = invoiceNumber;
    document.getElementById('print-customer-name').textContent = document.getElementById('customer-name').value;
    document.getElementById('print-customer-phone').textContent = document.getElementById('customer-phone').value;
    document.getElementById('print-discount').textContent = document.getElementById('discount').value;
    document.getElementById('print-total').textContent = document.getElementById('total-amount').textContent;
    document.getElementById('print-loan').textContent = document.getElementById('loan-amount').value || "0";
    document.getElementById('print-loan-note').textContent = document.getElementById('loan-note').value || "-";
    document.getElementById('print-date').textContent = new Date().toLocaleString();

    const printItems = document.getElementById('print-items');
    printItems.innerHTML = '';
    cart.forEach(item => {
      const line = document.createElement('div');
      line.textContent = `${item.name} x${item.qty} = Rs. ${(item.qty * item.price).toFixed(2)}`;
      printItems.appendChild(line);
    });

    // Save to Firebase
    db.ref('bills/' + invoiceNumber).set({
      invoice: invoiceNumber,
      customer: document.getElementById('customer-name').value,
      phone: document.getElementById('customer-phone').value,
      discount: parseFloat(document.getElementById('discount').value),
      total: parseFloat(document.getElementById('total-amount').textContent),
      loan: {
        amount: parseFloat(document.getElementById('loan-amount').value || 0),
        note: document.getElementById('loan-note').value || ''
      },
      items: cart,
      date: new Date().toISOString()
    });

    window.print();
  }

  function sendWhatsAppBill() {
    let msg = `üßæ *WR Smile & Supplies*\nInvoice: ${invoiceNumber}\n`;
    cart.forEach(p => {
      msg += `- ${p.name} x${p.qty} = Rs.${(p.qty * p.price).toFixed(2)}\n`;
    });
    msg += `Discount: Rs.${document.getElementById('discount').value}\n`;
    msg += `Total: Rs.${document.getElementById('total-amount').textContent}\n`;
    const phone = document.getElementById('customer-phone').value;
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;
    doc.text("WR Smile & Supplies", 10, y); y += 10;
    doc.text("Invoice: " + invoiceNumber, 10, y); y += 10;
    cart.forEach(p => {
      doc.text(`${p.name} x${p.qty} = Rs.${(p.qty * p.price).toFixed(2)}`, 10, y); y += 10;
    });
    doc.text("Discount: Rs." + document.getElementById('discount').value, 10, y); y += 10;
    doc.text("Total: Rs." + document.getElementById('total-amount').textContent, 10, y);
    doc.save(invoiceNumber + ".pdf");
  }

  // Product search
  document.getElementById('product-search').addEventListener('input', e => {
    const val = e.target.value.toLowerCase();
    const list = document.getElementById('search-results');
    list.innerHTML = '';
    db.ref('products').once('value', snap => {
      snap.forEach(child => {
        const p = child.val();
        if (p.name.toLowerCase().includes(val)) {
          const item = document.createElement('a');
          item.className = 'list-group-item list-group-item-action';
          item.textContent = `${p.name} - Rs.${p.price}`;
          item.onclick = () => {
            cart.push({ name: p.name, price: p.price, qty: 1 });
            e.target.value = '';
            list.innerHTML = '';
            updateCart();
          };
          list.appendChild(item);
        }
      });
    });
  });
</script>
</body>
</html>
