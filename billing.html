<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WR Smile - Billing with Pending Loan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      background: #f2f4f8;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 960px;
      margin-top: 40px;
    }
    .cart-box {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
    }
    .cart-item input {
      width: 50px;
    }
    .cart-item span {
      flex: 1;
    }
    .list-group-item {
      cursor: pointer;
    }
    .autocomplete-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
      z-index: 1000;
    }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">ðŸ§¾ WR Smile - Billing with Pending Loan</h2>

  <div class="mb-3 position-relative">
    <label>Customer Name</label>
    <input type="text" id="customer-name" class="form-control" autocomplete="off" placeholder="Start typing customer name" oninput="searchCustomers()" />
    <div id="customer-suggestions" class="list-group autocomplete-suggestions" style="display:none"></div>
  </div>

  <div class="mb-3 position-relative">
    <label>Customer Phone</label>
    <input type="tel" id="customer-phone" class="form-control" autocomplete="off" placeholder="Start typing phone number" oninput="searchCustomersByPhone()" />
    <div id="phone-suggestions" class="list-group autocomplete-suggestions" style="display:none"></div>
  </div>

  <div class="mb-3">
    <label>Pending Loan Amount (Rs.)</label>
    <input type="text" id="pending-loan" class="form-control" readonly value="0.00" />
  </div>

  <div class="row g-2 mb-3">
    <div class="col-md-4"><input type="text" id="manual-name" class="form-control" placeholder="Product name"></div>
    <div class="col-md-3"><input type="number" id="manual-price" class="form-control" placeholder="Price"></div>
    <div class="col-md-2"><input type="number" id="manual-qty" class="form-control" placeholder="Qty" value="1"></div>
    <div class="col-md-3"><button class="btn btn-secondary w-100" onclick="addManualProduct()">Add</button></div>
  </div>

  <div class="mb-3">
    <label>Discount (Rs.)</label>
    <input type="number" id="discount" class="form-control" value="0" oninput="updateTotals()" />
  </div>

  <div class="mb-3">
    <label>Loan Amount (Rs.) (optional)</label>
    <input type="number" id="loan-amount" class="form-control" placeholder="0" oninput="updateTotals()" />
  </div>

  <div class="mb-3">
    <label>Cash Paid (Rs.)</label>
    <input type="number" id="cash-paid" class="form-control" placeholder="0" oninput="updateTotals()" />
  </div>

  <div class="mb-3">
    <label>Balance to Give (Rs.)</label>
    <input type="text" id="balance" class="form-control" readonly value="0.00" />
  </div>

  <div class="mb-3">
    <label>Loan Note</label>
    <input type="text" id="loan-note" class="form-control" placeholder="Installment plan, etc" />
  </div>

  <div class="cart-box">
    <h5>ðŸ›’ Cart</h5>
    <div id="cart-items"></div>
    <h5 class="mt-3">Total: Rs. <span id="total-amount">0.00</span></h5>
    <div class="d-grid gap-2 d-md-block mt-3">
      <button class="btn btn-success" onclick="finalizeBill()">âœ… Save Bill</button>
      <button class="btn btn-primary ms-2" onclick="sendWhatsAppBill()">ðŸ“² Send WhatsApp</button>
    </div>
  </div>
</div>

<script>
  // Your Firebase config here:
  const firebaseConfig = {
    apiKey: "AIzaSyACehOi7n-dbdN00D4tJr2kD_-AVR6S-Vo",
    authDomain: "wr-smile-shop.firebaseapp.com",
    projectId: "wr-smile-shop",
    storageBucket: "wr-smile-shop.appspot.com",
    messagingSenderId: "299864260187",
    appId: "1:299864260187:web:fa6af65ef95674aff1097e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let cart = [];
  let invoiceNumber = 'INV-' + Date.now();
  document.getElementById('invoice-number')?.setAttribute('value', invoiceNumber);

  let selectedCustomerId = null;

  // CUSTOMER SEARCH BY NAME
  async function searchCustomers() {
    const input = document.getElementById('customer-name');
    const val = input.value.trim().toLowerCase();
    const suggestions = document.getElementById('customer-suggestions');
    suggestions.style.display = 'none';
    suggestions.innerHTML = '';
    selectedCustomerId = null;
    document.getElementById('pending-loan').value = '0.00';

    if (!val) return;

    const snapshot = await db.ref('customers').orderByChild('name').startAt(val).endAt(val + "\uf8ff").limitToFirst(10).once('value');
    if (!snapshot.exists()) return;

    snapshot.forEach(child => {
      const c = child.val();
      if (c.name.toLowerCase().includes(val)) {
        const item = document.createElement('a');
        item.className = 'list-group-item list-group-item-action';
        item.textContent = `${c.name} (${c.phone})`;
        item.href = '#';
        item.onclick = e => {
          e.preventDefault();
          selectCustomer(child.key, c.name, c.phone);
          suggestions.style.display = 'none';
        };
        suggestions.appendChild(item);
        suggestions.style.display = 'block';
      }
    });
  }

  // CUSTOMER SEARCH BY PHONE
  async function searchCustomersByPhone() {
    const input = document.getElementById('customer-phone');
    const val = input.value.trim();
    const suggestions = document.getElementById('phone-suggestions');
    suggestions.style.display = 'none';
    suggestions.innerHTML = '';
    selectedCustomerId = null;
    document.getElementById('pending-loan').value = '0.00';

    if (!val) return;

    const snapshot = await db.ref('customers').orderByChild('phone').startAt(val).endAt(val + "\uf8ff").limitToFirst(10).once('value');
    if (!snapshot.exists()) return;

    snapshot.forEach(child => {
      const c = child.val();
      if (c.phone.includes(val)) {
        const item = document.createElement('a');
        item.className = 'list-group-item list-group-item-action';
        item.textContent = `${c.name} (${c.phone})`;
        item.href = '#';
        item.onclick = e => {
          e.preventDefault();
          selectCustomer(child.key, c.name, c.phone);
          suggestions.style.display = 'none';
        };
        suggestions.appendChild(item);
        suggestions.style.display = 'block';
      }
    });
  }

  // Select customer and show pending loan
  async function selectCustomer(id, name, phone) {
    selectedCustomerId = id;
    document.getElementById('customer-name').value = name;
    document.getElementById('customer-phone').value = phone;

    document.getElementById('customer-suggestions').style.display = 'none';
    document.getElementById('customer-suggestions').innerHTML = '';
    document.getElementById('phone-suggestions').style.display = 'none';
    document.getElementById('phone-suggestions').innerHTML = '';

    const pendingLoan = await fetchPendingLoan(id);
    document.getElementById('pending-loan').value = pendingLoan.toFixed(2);
  }

  // Fetch sum of unpaid loan balances for customer
  async function fetchPendingLoan(customerId) {
    let totalPending = 0;
    const loansSnapshot = await db.ref('loans').orderByChild('customerId').equalTo(customerId).once('value');
    loansSnapshot.forEach(child => {
      const loan = child.val();
      if (loan.balance && loan.balance > 0) {
        totalPending += loan.balance;
      }
    });
    return totalPending;
  }

  // CART MANAGEMENT
  function updateCart() {
    const container = document.getElementById('cart-items');
    container.innerHTML = '';
    let total = 0;
    cart.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <span>${item.name}</span>
        <input type="number" min="1" value="${item.qty}" onchange="updateQty(${i}, this.value)" />
        <span>Rs. ${(item.price * item.qty).toFixed(2)}</span>
        <button class="btn btn-sm btn-danger" onclick="removeItem(${i})">x</button>
      `;
      container.appendChild(div);
      total += item.price * item.qty;
    });

    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const loanAmt = parseFloat(document.getElementById('loan-amount').value) || 0;
    const cashPaid = parseFloat(document.getElementById('cash-paid').value) || 0;
    const totalAfterDiscount = total - discount;
    document.getElementById('total-amount').textContent = totalAfterDiscount.toFixed(2);

    // Calculate balance to give: (total - discount - cashPaid - loanAmt)
    const balance = totalAfterDiscount - cashPaid - loanAmt;
    document.getElementById('balance').value = balance >= 0 ? balance.toFixed(2) : '0.00';
  }

  function addManualProduct() {
    const name = document.getElementById('manual-name').value.trim();
    const price = parseFloat(document.getElementById('manual-price').value);
    const qty = parseInt(document.getElementById('manual-qty').value);

    if (!name) return alert("Please enter product name");
    if (isNaN(price) || price <= 0) return alert("Please enter valid price");
    if (isNaN(qty) || qty <= 0) return alert("Please enter valid quantity");

    cart.push({ name, price, qty });
    updateCart();

    document.getElementById('manual-name').value = '';
    document.getElementById('manual-price').value = '';
    document.getElementById('manual-qty').value = 1;
  }

  function updateQty(index, value) {
    const qty = parseInt(value);
    if (isNaN(qty) || qty <= 0) return alert("Invalid quantity");
    cart[index].qty = qty;
    updateCart();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    updateCart();
  }

  // SAVE BILL & LOAN DATA
  async function finalizeBill() {
    const name = document.getElementById('customer-name').value.trim();
    const phone = document.getElementById('customer-phone').value.trim();
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const loanAmount = parseFloat(document.getElementById('loan-amount').value) || 0;
    const cashPaid = parseFloat(document.getElementById('cash-paid').value) || 0;
    const loanNote = document.getElementById('loan-note').value.trim();
    const totalText = document.getElementById('total-amount').textContent;
    const total = parseFloat(totalText) || 0;

    if (!name || !phone) return alert("Please enter customer name and phone.");
    if (cart.length === 0) return alert("Cart is empty.");
    if (cashPaid + loanAmount > total + discount) return alert("Cash paid and loan amount cannot exceed total amount.");

    // Check if customer exists, else create
    if (!selectedCustomerId) {
      // Search by phone in customers to avoid duplicate
      const snap = await db.ref('customers').orderByChild('phone').equalTo(phone).once('value');
      if (snap.exists()) {
        selectedCustomerId = Object.keys(snap.val())[0];
      } else {
        // Create new customer
        const newCustRef = db.ref('customers').push();
        await newCustRef.set({ name, phone });
        selectedCustomerId = newCustRef.key;
      }
    }

    // Prepare bill data
    const billData = {
      invoiceNumber: invoiceNumber,
      customerId: selectedCustomerId,
      customerName: name,
      customerPhone: phone,
      discount,
      totalAmount: total,
      loanAmount,
      cashPaid,
      balance: total - discount - loanAmount - cashPaid,
      loanNote,
      products: cart,
      date: new Date().toISOString(),
    };

    // Save sale
    await db.ref('sales').push(billData);

    // Save loan if loan amount > 0
    if (loanAmount > 0) {
      // Loan object stores balance = loanAmount initially
      const loanObj = {
        customerId: selectedCustomerId,
        loanAmount,
        balance: loanAmount,
        note: loanNote,
        date: new Date().toISOString(),
      };
      await db.ref('loans').push(loanObj);
    }

    alert("âœ… Bill saved successfully!");
    location.reload();
  }

  // WHATSAPP BILL SENDING
  function sendWhatsAppBill() {
    const name = document.getElementById('customer-name').value.trim();
    const phoneRaw = document.getElementById('customer-phone').value.trim();
    const phone = phoneRaw.replace(/\D/g, ''); // digits only

    if (!name || !phone) {
      return alert("Please enter valid customer name and phone to send WhatsApp message.");
    }
    if (cart.length === 0) {
      return alert("Cart is empty, add products before sending WhatsApp message.");
    }

    let msg = `ðŸ§¾ *WR Smile & Supplies*\n*Customer:* ${name}\n*Phone:* ${phoneRaw}\n\n*Invoice:* ${invoiceNumber}\n\n`;

    cart.forEach(p => {
      msg += `- ${p.name} x${p.qty} = Rs.${(p.price * p.qty).toFixed(2)}\n`;
    });

    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const total = parseFloat(document.getElementById('total-amount').textContent) || 0;
    const loanAmount = parseFloat(document.getElementById('loan-amount').value) || 0;
    const cashPaid = parseFloat(document.getElementById('cash-paid').value) || 0;
    const balance = parseFloat(document.getElementById('balance').value) || 0;
    const loanNote = document.getElementById('loan-note').value.trim();

    msg += `\nDiscount: Rs.${discount.toFixed(2)}`;
    msg += `\nTotal: Rs.${total.toFixed(2)}`;
    msg += `\nLoan Amount: Rs.${loanAmount.toFixed(2)} (${loanNote || '-'})`;
    msg += `\nCash Paid: Rs.${cashPaid.toFixed(2)}`;
    msg += `\nBalance to Give: Rs.${balance.toFixed(2)}`;

    // WhatsApp URL encode message
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

    window.open(url, '_blank');
  }

  // Initialize totals & invoice number display
  updateCart();

</script>
</body>
</html>

