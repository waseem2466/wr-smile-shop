<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WR Smile - Billing</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { background: #f2f4f8; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 960px; margin-top: 40px; }
    .cart-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
    .cart-item input { width: 50px; }
    .cart-item span { flex: 1; }
    .list-group-item { cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">ðŸ§¾ WR Smile - Billing</h2>

  <div class="mb-3">
    <label>Customer Phone</label>
    <input type="tel" id="customer-phone" class="form-control">
    <small class="text-muted" id="pending-loan-info"></small>
  </div>

  <div class="mb-3">
    <label>Customer Name</label>
    <input type="text" id="customer-name" class="form-control">
  </div>

  <div class="row g-2 mb-3">
    <div class="col-md-4"><input type="text" id="manual-name" class="form-control" placeholder="Product name"></div>
    <div class="col-md-3"><input type="number" id="manual-price" class="form-control" placeholder="Price"></div>
    <div class="col-md-2"><input type="number" id="manual-qty" class="form-control" placeholder="Qty" value="1"></div>
    <div class="col-md-3"><button class="btn btn-secondary w-100" onclick="addManualProduct()">Add</button></div>
  </div>

  <div class="mb-3">
    <label>Discount</label>
    <input type="number" id="discount" class="form-control" value="0">
  </div>

  <div class="mb-3">
    <label>Loan Amount (optional)</label>
    <input type="number" id="loan-amount" class="form-control" placeholder="0">
  </div>
  <div class="mb-3">
    <label>Loan Note</label>
    <input type="text" id="loan-note" class="form-control" placeholder="Installment plan, etc">
  </div>

  <div class="mb-3">
    <label>Cash Paid</label>
    <input type="number" id="cash-paid" class="form-control" placeholder="Enter cash paid">
  </div>

  <div class="cart-box">
    <h5>ðŸ›’ Cart</h5>
    <div id="cart-items"></div>
    <h5 class="mt-3">Total: Rs. <span id="total-amount">0.00</span></h5>
    <div class="d-grid gap-2 d-md-block mt-3">
      <button class="btn btn-success" onclick="finalizeBill()">âœ… Save Bill</button>
      <button class="btn btn-primary" onclick="sendWhatsAppBill()">ðŸ“² WhatsApp Bill</button>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyACehOi7n-dbdN00D4tJr2kD_-AVR6S-Vo",
    authDomain: "wr-smile-shop.firebaseapp.com",
    projectId: "wr-smile-shop",
    storageBucket: "wr-smile-shop.appspot.com",
    messagingSenderId: "299864260187",
    appId: "1:299864260187:web:fa6af65ef95674aff1097e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let cart = [];
  let invoiceNumber = 'INV-' + Date.now();

  document.getElementById('customer-phone').addEventListener('change', async function () {
    const phone = this.value.trim();
    if (!phone) return;
    const customersRef = db.ref('customers');
    const loansRef = db.ref('loans');

    let customerName = '';
    let customerId = null;

    await customersRef.orderByChild('phone').equalTo(phone).once('value', snap => {
      if (snap.exists()) {
        const data = Object.entries(snap.val())[0];
        customerId = data[0];
        customerName = data[1].name;
        document.getElementById('customer-name').value = customerName;
      }
    });

    if (customerId) {
      let pending = 0;
      await loansRef.orderByChild('customerId').equalTo(customerId).once('value', snap => {
        snap.forEach(child => {
          const loan = child.val();
          pending += (loan.totalAmount || 0) - (loan.paidAmount || 0);
        });
      });
      document.getElementById('pending-loan-info').textContent = pending > 0 ? `Pending Loan: Rs. ${pending.toFixed(2)}` : '';
    }
  });

  function updateCart() {
    const container = document.getElementById('cart-items');
    container.innerHTML = '';
    let total = 0;
    cart.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <span>${item.name}</span>
        <input type="number" value="${item.qty}" onchange="updateQty(${i}, this.value)">
        <span>Rs. ${(item.qty * item.price).toFixed(2)}</span>
        <button onclick="removeItem(${i})" class="btn btn-sm btn-danger">x</button>
      `;
      container.appendChild(div);
      total += item.qty * item.price;
    });
    let discount = parseFloat(document.getElementById('discount').value || 0);
    document.getElementById('total-amount').textContent = (total - discount).toFixed(2);
  }

  function addManualProduct() {
    const name = document.getElementById('manual-name').value;
    const price = parseFloat(document.getElementById('manual-price').value);
    const qty = parseInt(document.getElementById('manual-qty').value);
    if (!name || isNaN(price) || qty < 1) return alert('Invalid product input');
    cart.push({ name, price, qty });
    updateCart();
    document.getElementById('manual-name').value = '';
    document.getElementById('manual-price').value = '';
  }

  function updateQty(index, qty) {
    cart[index].qty = parseInt(qty);
    updateCart();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    updateCart();
  }

  async function finalizeBill() {
    const name = document.getElementById('customer-name').value.trim();
    const phone = document.getElementById('customer-phone').value.trim();
    const discount = parseFloat(document.getElementById('discount').value || 0);
    const loanAmount = parseFloat(document.getElementById('loan-amount').value || 0);
    const note = document.getElementById('loan-note').value.trim();
    const total = parseFloat(document.getElementById('total-amount').textContent);
    const cashPaid = parseFloat(document.getElementById('cash-paid').value || 0);

    if (!name || !phone || cart.length === 0) return alert("Please fill customer info and cart.");

    const customersRef = db.ref('customers');
    const loansRef = db.ref('loans');
    const salesRef = db.ref('sales');
    let customerId = null;

    await customersRef.orderByChild('phone').equalTo(phone).once('value', snap => {
      if (snap.exists()) {
        customerId = Object.keys(snap.val())[0];
      }
    });

    if (!customerId) {
      const newCustomerRef = customersRef.push();
      await newCustomerRef.set({ name, phone });
      customerId = newCustomerRef.key;
    }

    const billData = {
      invoiceNumber,
      customerId,
      loanNote: note,
      products: cart,
      discount,
      totalAmount: total,
      paidAmount: cashPaid,
      balance: total - cashPaid,
      loanDate: new Date().toISOString(),
    };

    if ((loanAmount > 0) || (total > cashPaid)) {
      await loansRef.push(billData);
      alert("âœ… Loan saved successfully!");
    } else {
      await salesRef.push(billData);
      alert("âœ… Sale saved successfully!");
    }
    location.reload();
  }

  function sendWhatsAppBill() {
    const phone = document.getElementById('customer-phone').value;
    let msg = `ðŸ§¾ *WR Smile & Supplies*\nInvoice: ${invoiceNumber}\n`;
    cart.forEach(p => {
      msg += `- ${p.name} x${p.qty} = Rs.${(p.qty * p.price).toFixed(2)}\n`;
    });
    msg += `Discount: Rs.${document.getElementById('discount').value}\n`;
    msg += `Total: Rs.${document.getElementById('total-amount').textContent}`;
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
  }
</script>
</body>
</html>
